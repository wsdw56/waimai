<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美团API商家信息提取器 (自动定位版)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        #tokenInput { width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 15px; }
        .button-group { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 10px; margin-bottom: 15px; }
        .button-group button { padding: 12px; font-size: 16px; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        #prevButton { background-color: #6c757d; }
        #queryButton { background-color: #007bff; }
        #nextButton { background-color: #28a745; }
        .button-group button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #status { font-weight: bold; color: #337ab7; padding: 10px; background-color: #e7f3fe; border: 1px solid #bce8f1; border-radius: 4px; margin-top: 15px; text-align: center;}
        #results { margin-top: 20px; }
        .page-section { border: 1px solid #ddd; border-radius: 5px; background: #fff; }
        .page-header { background-color: #f7f7f7; padding: 10px 15px; border-bottom: 1px solid #ddd; font-weight: bold; color: #d9534f; border-radius: 5px 5px 0 0; }
        
        /* 商家列表样式 */
        #merchantList { padding: 10px 15px; max-height: 60vh; overflow-y: auto; }
        .merchant-item { border-bottom: 1px solid #eee; padding: 15px 5px; display: grid; grid-template-columns: 1fr auto; gap: 15px; }
        .merchant-item:last-child { border-bottom: none; }
        .merchant-info h3 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
        .merchant-info p { margin: 0; font-size: 14px; color: #777; }
        .action-buttons { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; justify-content: center; }
        .action-buttons .btn { display: inline-block; text-decoration: none; color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; white-space: nowrap; transition: background-color 0.2s; border: none; cursor: pointer; text-align: center; min-width: 90px; }
        .btn.direct-link-btn { background-color: #ff8c00; }
        .btn.direct-link-btn:hover { background-color: #e07b00; }
        .btn.copy-link-btn { background-color: #17a2b8; }
        .btn.copy-link-btn:hover { background-color: #138496; }
        .btn.qr-code-btn { background-color: #28a745; }
        .btn.qr-code-btn:hover { background-color: #218838; }

        /* 页码导航样式 */
        .pagination { text-align: center; margin-top: 10px; padding-top: 5px; }
        .pagination button { background-color: #fff; border: 1px solid #ddd; color: #007bff; padding: 6px 12px; margin: 0 3px; cursor: pointer; border-radius: 4px; }
        .pagination button:hover { background-color: #e9ecef; }
        .pagination button.active { background-color: #007bff; color: white; cursor: default; }

        /* 二维码弹窗样式 */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 280px; text-align: center; border-radius: 8px; position: relative; }
        .modal-content img { max-width: 100%; height: auto; }
        .close-btn { position: absolute; top: 5px; right: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>美团接口商家信息提取器 (自动定位版)</h1>
        <p><strong>重要提示：</strong>点击“查询”后，浏览器会请求您的地理位置权限。**请务必点击“允许”**，否则无法查询您附近的商家。</p>
        
        <label for="tokenInput">请输入 Token:</label>
        <input type="text" id="tokenInput" placeholder="在此处粘贴您的Token">

        <div class="button-group">
            <button id="prevButton" disabled>上一页</button>
            <button id="queryButton">查询</button>
            <button id="nextButton" disabled>下一页</button>
        </div>
        <div id="paginationControls" class="pagination"></div>
        <p id="status">状态：准备就绪</p>
    </div>

    <div class="container" id="results">
        <div class="page-section">
            <div class="page-header" id="responseHeader">商家列表</div>
            <div id="merchantList">
                <p style="text-align: center; color: #888;">请点击“查询”按钮开始请求...</p>
            </div>
        </div>
    </div>

    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <p>请使用手机扫描二维码</p>
            <img id="qrCodeImg" src="" alt="QR Code">
        </div>
    </div>

<script>
    const apiUrl = 'https://adapi.waimai.meituan.com/api/ad/landingPage';

    // Elements
    const queryButton = document.getElementById('queryButton');
    const nextButton = document.getElementById('nextButton');
    const prevButton = document.getElementById('prevButton');
    const tokenInput = document.getElementById('tokenInput');
    const statusDiv = document.getElementById('status');
    const responseHeader = document.getElementById('responseHeader');
    const merchantListDiv = document.getElementById('merchantList');
    const paginationControls = document.getElementById('paginationControls');
    const qrModal = document.getElementById('qrModal');
    const qrCodeImg = document.getElementById('qrCodeImg');
    const closeBtn = document.querySelector('.close-btn');
    
    tokenInput.value = 'AgF2J3zrwXL8QIPaOQhL_D_1jje-fbTxFBd0gTKsWxAe6am2ORrTp8KT4rhYk5qWmKkWyI9mgTDmvAAAAAD1LgAA-byxioMtN1OG3Ot1iKBHi6jF61tNCzC6VSP32umUyMw3opOfoO10khlciGWH2gXM';

    // State
    let currentPageNum = 0;
    let pageCache = [];
    let isFetching = false;
    let userLatitude = null;
    let userLongitude = null;

    // --- NEW: Geolocation Function ---
    function getUserLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject({ code: -1, message: "您的浏览器不支持地理定位。" });
            } else {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0
                });
            }
        });
    }

    async function fetchData(pageNum, wmContext, token) {
        updateStatus(`正在请求第 ${pageNum + 1} 页...`);
        // 使用获取到的用户经纬度
        const baseParams = new URLSearchParams({
            notitlebar: '1', future: '2', scene_id: '179', entry: 'tiantianmiandan',
            wmUserIdDeregistration: '0', wmUuidDeregistration: '1', wm_appversion: '12.46.403',
            wm_ctype: 'mtandroid', userid: '5543192494', 
            uuid: '000000000000005100380EF384E64B6B41161CD779322A174200374470317960',
            personalized: '1', platform: '4', 
            wm_latitude: userLatitude, // 动态
            poilist_mt_cityid: '157', // 注意: 这个城市ID可能需要根据经纬度反向解析, 但目前API似乎不强制
            wm_actual_longitude: userLongitude, // 动态
            content_personalized_switch: '0',
            ad_personalized_switch: '0', wm_visitid: '7fd0a8af-6278-4878-9fd4-17ad423cc5ac',
            wm_dversion: '33_13', push_token: 'dpshddfdded7858bc51ace78bf56d28b8d2aatpu',
            app: '0', poilist_wm_cityid: '211000', // 注意: 这个城市ID可能也需要更新
            wm_longitude: userLongitude, // 动态
            wm_actual_latitude: userLatitude, // 动态
            wm_pwh: '1', f: 'android', version: '12.46.403',
            app_model: '0', wm_dtype: 'M2011K2C',
            wm_uuid: '000000000000005100380EF384E64B6B41161CD779322A174200374470317960',
            partner: '4', utm_term: '1200460403', utm_campaign: 'AgroupBgroupC0D500E0Ghomepage',
            ci: '157', utm_medium: 'android', utm_source: 'xiaomi', utm_content: '',
            region_id: '1000341300', region_version: '1763347289584', entry_channel: '2',
            page_size: '10', filterInfo: '', sortType: '0', clicked_poi_str: '',
            clicked_poi_channel: '', ad_page_type: '0',
            token: token,
            wm_logintoken: token,
            page_num: pageNum,
            wm_context: wmContext || '',
        });
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: baseParams.toString(),
            });
            if (!response.ok) throw new Error(`HTTP 错误! 状态: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('请求失败:', error);
            updateStatus(`请求失败: ${error.message}。请检查浏览器控制台以获取CORS错误详情。`);
            return null;
        }
    }
    
    function updateStatus(message) { statusDiv.textContent = `状态：${message}`; }
    
    function setButtonsState(loading) {
        isFetching = loading;
        queryButton.disabled = loading;
        if (!loading) {
            prevButton.disabled = currentPageNum <= 0;
            const hasNextPage = pageCache[currentPageNum]?.data?.json_data?.page?.hasNextPage;
            nextButton.disabled = !hasNextPage;
        } else {
            prevButton.disabled = true;
            nextButton.disabled = true;
        }
        renderPagination();
    }
    
    function renderPagination() {
        paginationControls.innerHTML = '';
        if (pageCache.length === 0) return;
        pageCache.forEach((_, index) => {
            const pageButton = document.createElement('button');
            pageButton.textContent = index + 1;
            if (index === currentPageNum) {
                pageButton.classList.add('active');
            }
            pageButton.onclick = () => { displayPage(index); };
            paginationControls.appendChild(pageButton);
        });
    }

    function displayPage(pageIndex) {
        const responseData = pageCache[pageIndex];
        if (!responseData) return;

        currentPageNum = pageIndex;
        responseHeader.textContent = `商家列表 - 第 ${currentPageNum + 1} 页`;
        merchantListDiv.innerHTML = '';

        const moduleList = responseData.data?.module_list;
        if (!moduleList || moduleList.length === 0) {
            merchantListDiv.innerHTML = '<p style="text-align: center; color: #888;">当前页没有商家信息。</p>';
            setButtonsState(false);
            return;
        }

        moduleList.forEach(item => {
            try {
                const stringData = JSON.parse(item.string_data);
                const adData = JSON.parse(stringData.ad_data);
                const name = adData.poi_name || '未知商家';
                const distance = adData.distance || '未知距离';
                const scheme = adData.scheme;

                if (scheme) {
                    const merchantElement = document.createElement('div');
                    merchantElement.className = 'merchant-item';
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'merchant-info';
                    infoDiv.innerHTML = `<h3>${name}</h3><p>距离：${distance}</p>`;
                    
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'action-buttons';
                    
                    const directLink = document.createElement('a');
                    directLink.href = scheme;
                    directLink.className = 'btn direct-link-btn';
                    directLink.textContent = '点此直达';
                    directLink.target = '_blank';

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'btn copy-link-btn';
                    copyBtn.textContent = '复制链接';
                    copyBtn.onclick = (e) => {
                        navigator.clipboard.writeText(scheme).then(() => {
                            e.target.textContent = '已复制!';
                            setTimeout(() => { e.target.textContent = '复制链接'; }, 2000);
                        });
                    };

                    const qrBtn = document.createElement('button');
                    qrBtn.className = 'btn qr-code-btn';
                    qrBtn.textContent = '生成二维码';
                    qrBtn.onclick = () => {
                        const qrApiUrl = `https://api.2dcode.biz/v1/create-qr-code?data=${encodeURIComponent(scheme)}`;
                        openModal(qrApiUrl);
                    };

                    buttonsDiv.appendChild(directLink);
                    buttonsDiv.appendChild(copyBtn);
                    buttonsDiv.appendChild(qrBtn);
                    merchantElement.appendChild(infoDiv);
                    merchantElement.appendChild(buttonsDiv);
                    merchantListDiv.appendChild(merchantElement);
                }
            } catch (e) {
                console.error("解析商家数据失败:", e, "错误的item:", item);
            }
        });
        updateStatus(`已显示第 ${currentPageNum + 1} 页的数据。`);
        setButtonsState(false);
    }
    
    async function fetchAndCachePage(pageIndex) {
        if (pageCache[pageIndex]) {
            displayPage(pageIndex);
            return;
        }
        const tokenValue = tokenInput.value.trim();
        if (!tokenValue) { alert('请输入Token！'); return; }
        if (isFetching) return;
        setButtonsState(true);

        const wmContext = pageIndex > 0 ? pageCache[pageIndex - 1].data.json_data.wm_context : '';
        const responseData = await fetchData(pageIndex, wmContext, tokenValue);

        if (responseData && responseData.code === 0) {
            pageCache[pageIndex] = responseData;
            displayPage(pageIndex);
        } else {
            updateStatus(`请求第 ${pageIndex + 1} 页失败，请重试。`);
            merchantListDiv.innerHTML = `<p style="text-align: center; color: #d9534f;">请求失败，请检查Token或网络后重试。</p>`;
            setButtonsState(false);
        }
    }

    function openModal(qrUrl) {
        qrCodeImg.src = qrUrl;
        qrModal.style.display = 'flex';
    }
    function closeModal() {
        qrModal.style.display = 'none';
        qrCodeImg.src = '';
    }
    closeBtn.onclick = closeModal;
    window.onclick = function(event) { if (event.target == qrModal) { closeModal(); } };

    // --- UPDATED: Query Button Event Listener ---
    queryButton.addEventListener('click', async () => {
        currentPageNum = 0;
        pageCache = [];
        merchantListDiv.innerHTML = '';
        paginationControls.innerHTML = '';
        responseHeader.textContent = '商家列表';
        queryButton.disabled = true;

        updateStatus("正在请求地理位置权限...");
        try {
            const position = await getUserLocation();
            // Convert coordinates to the format required by the API
            userLatitude = Math.round(position.coords.latitude * 1000000);
            userLongitude = Math.round(position.coords.longitude * 1000000);
            updateStatus(`位置获取成功: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
            
            // Now, start fetching data with the new location
            await fetchAndCachePage(0);

        } catch (error) {
            let errorMessage = "获取地理位置时发生未知错误。";
            if (error.code) {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "获取地理位置失败，您拒绝了请求。请允许位置权限后重试。";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "无法获取当前位置信息。";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "获取位置信息超时。";
                        break;
                }
            } else {
                errorMessage = error.message;
            }
            updateStatus(errorMessage);
            alert(errorMessage);
            queryButton.disabled = false;
        }
    });

    nextButton.addEventListener('click', () => { fetchAndCachePage(currentPageNum + 1); });
    prevButton.addEventListener('click', () => { if (currentPageNum > 0) { displayPage(currentPageNum - 1); } });
</script>
</body>
</html>
